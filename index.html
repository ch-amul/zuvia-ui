<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Zuvia Tracker (GitHub Storage)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: #faf7f4;
      color: #333;
    }
    header {
      background: #111;
      color: #f7f1ea;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.2rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }
    header span {
      font-size: 0.8rem;
      opacity: 0.7;
    }
    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 1rem 1.5rem 2rem;
    }
    .config {
      background: #fff;
      border-radius: 10px;
      padding: 0.75rem 1rem;
      border: 1px solid #ddd;
      margin-bottom: 1rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.5rem 0.75rem;
      align-items: end;
    }
    .config label {
      font-size: 0.75rem;
      display: block;
      margin-bottom: 0.2rem;
    }
    .config input {
      width: 100%;
      box-sizing: border-box;
      padding: 0.35rem 0.5rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.8rem;
    }
    .config button {
      border-radius: 999px;
      border: none;
      padding: 0.45rem 0.9rem;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .btn-primary {
      background: #111;
      color: #fff;
    }
    .btn-secondary {
      background: #e8e1d8;
      color: #333;
    }
    .status {
      font-size: 0.8rem;
      margin-top: 0.2rem;
      color: #666;
    }
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      border-bottom: 1px solid #ddd;
    }
    .tab {
      padding: 0.4rem 0.8rem;
      border-radius: 999px 999px 0 0;
      border: none;
      cursor: pointer;
      background: transparent;
      font-size: 0.85rem;
    }
    .tab.active {
      background: #fff;
      border: 1px solid #ddd;
      border-bottom: 1px solid #fff;
    }
    .panel {
      display: none;
      background: #fff;
      border-radius: 0 0 12px 12px;
      border: 1px solid #ddd;
      padding: 0.8rem 1rem 1rem;
    }
    .panel.active {
      display: block;
    }
    h2 {
      font-size: 1rem;
      margin-top: 0;
      margin-bottom: 0.4rem;
    }
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 0.75rem 1rem;
      margin-bottom: 0.8rem;
      padding: 0.7rem;
      border-radius: 8px;
      background: #fafafa;
      border: 1px solid #eee;
    }
    label {
      font-size: 0.75rem;
      display: block;
      margin-bottom: 0.2rem;
    }
    input, select {
      width: 100%;
      box-sizing: border-box;
      padding: 0.35rem 0.5rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.8rem;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #111;
    }
    button {
      font-size: 0.8rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      margin-top: 0.4rem;
    }
    th, td {
      border-bottom: 1px solid #eee;
      padding: 0.35rem 0.4rem;
      text-align: left;
    }
    th {
      background: #f5f5f5;
      font-weight: 600;
    }
    tr:nth-child(even) {
      background: #fbfbfb;
    }
    .right {
      text-align: right;
    }
    .btn-danger {
      background: #e57373;
      color: #fff;
      border-radius: 999px;
      border: none;
      padding: 0.2rem 0.5rem;
    }
    .pill {
      padding: 0.15rem 0.45rem;
      border-radius: 999px;
      background: #eee;
      font-size: 0.65rem;
      display: inline-block;
      margin-left: 0.2rem;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>ZUVIA TRACKER</h1>
      <span>Fabrics & Designs · GitHub-backed</span>
    </div>
  </header>
  <main>
    <!-- Config / GitHub connection -->
    <section class="config">
      <div>
        <label>GitHub Username</label>
        <input id="ghUser" placeholder="e.g. ravali-j" />
      </div>
      <div>
        <label>Repo Name</label>
        <input id="ghRepo" placeholder="e.g. zuvia-tracker" />
      </div>
      <div>
        <label>Data File Path in Repo</label>
        <input id="ghFile" placeholder="e.g. data.json" />
      </div>
      <div>
        <label>GitHub Token (kept only in this browser)</label>
        <input id="ghToken" type="password" placeholder="personal access token" />
      </div>
      <div>
        <button id="loadBtn" class="btn-secondary" type="button">⬇ Load from GitHub</button>
      </div>
      <div>
        <button id="saveBtn" class="btn-primary" type="button">⬆ Save to GitHub</button>
      </div>
      <div class="status" id="statusText">Not connected.</div>
    </section>

    <div class="tabs">
      <button class="tab active" data-target="fabricsPanel">Fabrics</button>
      <button class="tab" data-target="designsPanel">Designs</button>
    </div>

    <!-- Fabrics -->
    <section id="fabricsPanel" class="panel active">
      <h2>Fabrics</h2>
      <form id="fabricForm">
        <div>
          <label>Fabric ID *</label>
          <input id="fabricId" required placeholder="FAB001" />
        </div>
        <div>
          <label>Name / Type *</label>
          <input id="fabricName" required placeholder="Rayon floral" />
        </div>
        <div>
          <label>Color / Print</label>
          <input id="fabricColor" placeholder="Sage green floral" />
        </div>
        <div>
          <label>Supplier</label>
          <input id="fabricSupplier" placeholder="Surat vendor" />
        </div>
        <div>
          <label>Meters Bought *</label>
          <input id="fabricMeters" type="number" step="0.01" min="0" required />
        </div>
        <div>
          <label>Cost per Meter *</label>
          <input id="fabricCostPerMeter" type="number" step="0.01" min="0" required />
        </div>
        <div>
          <label>Purchase Date</label>
          <input id="fabricDate" type="date" />
        </div>
        <div style="align-self:end;">
          <button class="btn-primary" type="submit">Add / Update Fabric</button>
        </div>
      </form>

      <table>
        <thead>
          <tr>
            <th>Fabric ID</th>
            <th>Name</th>
            <th>Color/Print</th>
            <th>Supplier</th>
            <th class="right">Meters</th>
            <th class="right">Cost/m</th>
            <th class="right">Total Cost</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="fabricTableBody"></tbody>
      </table>
    </section>

    <!-- Designs -->
    <section id="designsPanel" class="panel">
      <h2>Designs</h2>
      <form id="designForm">
        <div>
          <label>Design ID *</label>
          <input id="designId" required placeholder="D001" />
        </div>
        <div>
          <label>Design Name *</label>
          <input id="designName" required placeholder="Sage Tier Dress" />
        </div>
        <div>
          <label>Fabric *</label>
          <select id="designFabricId" required></select>
        </div>
        <div>
          <label>Pieces Produced *</label>
          <input id="designPieces" type="number" min="1" step="1" required />
        </div>
        <div>
          <label>Fabric per Piece (m) *</label>
          <input id="designFabricPerPiece" type="number" step="0.01" min="0" required />
        </div>
        <div>
          <label>Other Costs (total)</label>
          <input id="designOtherCost" type="number" step="0.01" min="0" placeholder="Tags, shoot, etc." />
        </div>
        <div style="align-self:end;">
          <button class="btn-primary" type="submit">Add / Update Design</button>
        </div>
      </form>

      <table>
        <thead>
          <tr>
            <th>Design ID</th>
            <th>Name</th>
            <th>Fabric</th>
            <th class="right">Pieces</th>
            <th class="right">Fabric Used (m)</th>
            <th class="right">Fabric Cost</th>
            <th class="right">Other Cost</th>
            <th class="right">Total Cost</th>
            <th class="right">Cost / Piece</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="designTableBody"></tbody>
      </table>
    </section>
  </main>

  <script>
    // --- State ---
    let state = { fabrics: [], designs: [] };
    let lastSha = null; // GitHub file SHA for updates

    const statusText = document.getElementById("statusText");

    // Load config from localStorage (for convenience)
    const configFields = ["ghUser","ghRepo","ghFile"];
    configFields.forEach(id => {
      const el = document.getElementById(id);
      const saved = localStorage.getItem("zuvia_" + id);
      if (saved) el.value = saved;
      el.addEventListener("change", () => {
        localStorage.setItem("zuvia_" + id, el.value);
      });
    });

    // --- GitHub API helpers ---
    function getConfig() {
      const user = document.getElementById("ghUser").value.trim();
      const repo = document.getElementById("ghRepo").value.trim();
      const file = document.getElementById("ghFile").value.trim() || "data.json";
      const token = document.getElementById("ghToken").value.trim();
      if (!user || !repo || !file || !token) {
        alert("Please fill GitHub username, repo, file path and token.");
        return null;
      }
      return { user, repo, file, token };
    }

    async function loadFromGitHub() {
      const cfg = getConfig();
      if (!cfg) return;
      statusText.textContent = "Loading from GitHub...";
      try {
        const res = await fetch(`https://api.github.com/repos/${cfg.user}/${cfg.repo}/contents/${cfg.file}`, {
          headers: { "Authorization": `Bearer ${cfg.token}`, "Accept": "application/vnd.github+json" }
        });
        if (res.status === 404) {
          // No file yet -> start empty
          state = { fabrics: [], designs: [] };
          lastSha = null;
          statusText.textContent = "No data file in repo yet. Starting fresh.";
          renderAll();
          return;
        }
        if (!res.ok) {
          const text = await res.text();
          throw new Error("GitHub error: " + text);
        }
        const json = await res.json();
        lastSha = json.sha;
        const content = atob(json.content.replace(/\n/g, ""));
        const parsed = JSON.parse(content);
        state = {
          fabrics: parsed.fabrics || [],
          designs: parsed.designs || []
        };
        statusText.textContent = "Loaded data from GitHub.";
        renderAll();
      } catch (err) {
        console.error(err);
        alert("Failed to load from GitHub. Check console for details.");
        statusText.textContent = "Error loading from GitHub.";
      }
    }

    async function saveToGitHub() {
      const cfg = getConfig();
      if (!cfg) return;
      statusText.textContent = "Saving to GitHub...";
      try {
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(state, null, 2))));
        const body = {
          message: "Update Zuvia data",
          content,
          branch: "main"
        };
        if (lastSha) body.sha = lastSha;

        const res = await fetch(`https://api.github.com/repos/${cfg.user}/${cfg.repo}/contents/${cfg.file}`, {
          method: "PUT",
          headers: {
            "Authorization": `Bearer ${cfg.token}`,
            "Accept": "application/vnd.github+json"
          },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error("GitHub error: " + text);
        }
        const json = await res.json();
        lastSha = json.content.sha;
        statusText.textContent = "Saved to GitHub.";
        alert("Data saved to GitHub successfully.");
      } catch (err) {
        console.error(err);
        alert("Failed to save to GitHub. Check console for details.");
        statusText.textContent = "Error saving to GitHub.";
      }
    }

    document.getElementById("loadBtn").addEventListener("click", loadFromGitHub);
    document.getElementById("saveBtn").addEventListener("click", saveToGitHub);

    // --- Tabs ---
    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".panel").forEach(p => p.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(tab.dataset.target).classList.add("active");
      });
    });

    // --- Fabrics UI ---
    const fabricForm = document.getElementById("fabricForm");
    const fabricTableBody = document.getElementById("fabricTableBody");

    fabricForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const id = document.getElementById("fabricId").value.trim();
      const name = document.getElementById("fabricName").value.trim();
      const color = document.getElementById("fabricColor").value.trim();
      const supplier = document.getElementById("fabricSupplier").value.trim();
      const meters = parseFloat(document.getElementById("fabricMeters").value) || 0;
      const costPerMeter = parseFloat(document.getElementById("fabricCostPerMeter").value) || 0;
      const purchaseDate = document.getElementById("fabricDate").value || null;

      if (!id || !name || !meters || !costPerMeter) {
        alert("Please fill Fabric ID, Name, Meters, Cost per meter.");
        return;
      }

      const existingIndex = state.fabrics.findIndex(f => f.id === id);
      const fabric = { id, name, color, supplier, meters, costPerMeter, purchaseDate };

      if (existingIndex >= 0) {
        state.fabrics[existingIndex] = fabric;
      } else {
        state.fabrics.push(fabric);
      }
      fabricForm.reset();
      renderAll();
    });

    function renderFabrics() {
      fabricTableBody.innerHTML = "";
      state.fabrics.forEach(fabric => {
        const tr = document.createElement("tr");
        const totalCost = fabric.meters * fabric.costPerMeter;
        tr.innerHTML = `
          <td>${fabric.id}</td>
          <td>${fabric.name}</td>
          <td>${fabric.color || ""}</td>
          <td>${fabric.supplier || ""}</td>
          <td class="right">${fabric.meters.toFixed(2)}</td>
          <td class="right">${fabric.costPerMeter.toFixed(2)}</td>
          <td class="right">${totalCost.toFixed(2)}</td>
          <td class="right">
            <button class="btn-secondary" data-edit-fabric="${fabric.id}">Edit</button>
            <button class="btn-danger" data-delete-fabric="${fabric.id}">X</button>
          </td>
        `;
        fabricTableBody.appendChild(tr);
      });

      fabricTableBody.querySelectorAll("[data-edit-fabric]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-edit-fabric");
          const fabric = state.fabrics.find(f => f.id === id);
          if (!fabric) return;
          document.getElementById("fabricId").value = fabric.id;
          document.getElementById("fabricName").value = fabric.name;
          document.getElementById("fabricColor").value = fabric.color || "";
          document.getElementById("fabricSupplier").value = fabric.supplier || "";
          document.getElementById("fabricMeters").value = fabric.meters;
          document.getElementById("fabricCostPerMeter").value = fabric.costPerMeter;
          document.getElementById("fabricDate").value = fabric.purchaseDate || "";
        });
      });

      fabricTableBody.querySelectorAll("[data-delete-fabric]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-delete-fabric");
          if (!confirm("Delete fabric " + id + "?")) return;
          state.fabrics = state.fabrics.filter(f => f.id !== id);
          renderAll();
        });
      });
    }

    // --- Designs UI ---
    const designForm = document.getElementById("designForm");
    const designTableBody = document.getElementById("designTableBody");
    const designFabricSelect = document.getElementById("designFabricId");

    designForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const id = document.getElementById("designId").value.trim();
      const name = document.getElementById("designName").value.trim();
      const fabricId = document.getElementById("designFabricId").value;
      const pieces = parseInt(document.getElementById("designPieces").value, 10) || 0;
      const fabricPerPiece = parseFloat(document.getElementById("designFabricPerPiece").value) || 0;
      const otherCost = parseFloat(document.getElementById("designOtherCost").value) || 0;

      if (!id || !name || !fabricId || !pieces || !fabricPerPiece) {
        alert("Please fill Design ID, Name, Fabric, Pieces, Fabric per piece.");
        return;
      }

      const existingIndex = state.designs.findIndex(d => d.id === id);
      const design = { id, name, fabricId, pieces, fabricPerPiece, otherCost };

      if (existingIndex >= 0) {
        state.designs[existingIndex] = design;
      } else {
        state.designs.push(design);
      }
      designForm.reset();
      renderAll();
    });

    function renderDesignFabricOptions() {
      designFabricSelect.innerHTML = "";
      if (state.fabrics.length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Add fabrics first";
        designFabricSelect.appendChild(opt);
        return;
      }
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Select fabric";
      designFabricSelect.appendChild(placeholder);

      state.fabrics.forEach(fabric => {
        const opt = document.createElement("option");
        opt.value = fabric.id;
        opt.textContent = `${fabric.id} - ${fabric.name}`;
        designFabricSelect.appendChild(opt);
      });
    }

    function renderDesigns() {
      designTableBody.innerHTML = "";
      state.designs.forEach(design => {
        const fabric = state.fabrics.find(f => f.id === design.fabricId);
        const fabricName = fabric ? fabric.name : "(missing)";
        const fabricCostPerMeter = fabric ? fabric.costPerMeter : 0;
        const totalFabricUsed = design.pieces * design.fabricPerPiece;
        const fabricCost = totalFabricUsed * fabricCostPerMeter;
        const otherCost = design.otherCost || 0;
        const totalCost = fabricCost + otherCost;
        const costPerPiece = design.pieces > 0 ? totalCost / design.pieces : 0;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${design.id}</td>
          <td>${design.name}</td>
          <td>${design.fabricId} <span class="pill">${fabricName}</span></td>
          <td class="right">${design.pieces}</td>
          <td class="right">${totalFabricUsed.toFixed(2)}</td>
          <td class="right">${fabricCost.toFixed(2)}</td>
          <td class="right">${otherCost.toFixed(2)}</td>
          <td class="right">${totalCost.toFixed(2)}</td>
          <td class="right">${costPerPiece.toFixed(2)}</td>
          <td class="right">
            <button class="btn-secondary" data-edit-design="${design.id}">Edit</button>
            <button class="btn-danger" data-delete-design="${design.id}">X</button>
          </td>
        `;
        designTableBody.appendChild(tr);
      });

      designTableBody.querySelectorAll("[data-edit-design]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-edit-design");
          const d = state.designs.find(x => x.id === id);
          if (!d) return;
          document.getElementById("designId").value = d.id;
          document.getElementById("designName").value = d.name;
          document.getElementById("designFabricId").value = d.fabricId;
          document.getElementById("designPieces").value = d.pieces;
          document.getElementById("designFabricPerPiece").value = d.fabricPerPiece;
          document.getElementById("designOtherCost").value = d.otherCost || "";
        });
      });

      designTableBody.querySelectorAll("[data-delete-design]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-delete-design");
          if (!confirm("Delete design " + id + "?")) return;
          state.designs = state.designs.filter(d => d.id !== id);
          renderAll();
        });
      });
    }

    function renderAll() {
      renderFabrics();
      renderDesignFabricOptions();
      renderDesigns();
    }

    // Initial empty render
    renderAll();
  </script>
</body>
</html>
